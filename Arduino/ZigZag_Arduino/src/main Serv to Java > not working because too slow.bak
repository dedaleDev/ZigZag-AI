#include <SPI.h>
#include <SD.h>
#include <Adafruit_VS1053.h>

#define CS_PIN 9
#define SD_CS 9
#define MISO 12
#define MOSI 11
#define SCK 13
#define XCS 6
#define XRESET 8
#define XDSC 7
#define DREQ 2

File audioFile;
File logFile;

#define SERIAL_RX_BUFFER_SIZE 256

void writeLog(const String &message) {
  logFile = SD.open("log.txt", FILE_WRITE);
  if (logFile) {
    logFile.println(message);
    logFile.close();
  }
}

void setup() {
  Serial.begin(115200);
  while (!Serial) { }

  if (!SD.begin(CS_PIN)) {
    writeLog("Erreur : Impossible d'initialiser la carte SD.");
    return;
  }

  audioFile = SD.open("received.wav", FILE_WRITE);
  if (!audioFile) {
    writeLog("Erreur : Impossible de créer le fichier audio.");
  }
}

void loop() {
  if (Serial.available() > 0) {
    byte preamble = Serial.read();

    if (preamble == 0xE4 || preamble == 0xA1) {
      writeLog("Préambule correct");
      while (Serial.available() < 4) {}
      byte f1 = Serial.read();
      byte f2 = Serial.read();
      byte l1 = Serial.read();
      byte l2 = Serial.read();

      uint16_t frameNumber = (f1 << 8) | f2;
      uint16_t lengthData = (l1 << 8) | l2;

      if (lengthData > 57) {
        writeLog("Erreur : Longueur des données > 57 octets.");
        return; 
      }

      byte buffer[57];
      if (lengthData > 0) {
        while ((int)Serial.available() < lengthData) {}
        Serial.readBytes(buffer, lengthData);
      }

      while (Serial.available() < 1) {}
      byte stopByte = Serial.read();
      if (stopByte != 0xAE) {
        writeLog("Erreur : Octet de stop incorrect.");
        return;
      }

      if (preamble == 0xE4 && audioFile) {
        audioFile.write(buffer, lengthData);
        audioFile.flush(); 
      } else if (preamble == 0xA1) {
        if (audioFile) {
          audioFile.close();
        }
      }
    } else {
      writeLog("Erreur : Préambule inconnu.");
    }
  }
}